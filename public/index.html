<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>User Table</title>
<style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #f5f7fa;
      color: #333;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    }
    header h1 {
      margin: 0;
      font-weight: 600;
      font-size: 1.5rem;
    }

    main {
      padding: 2rem;
      max-width: 100%;
      margin: 0 auto;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      background: white;
      box-shadow: 0 2px 12px rgb(0 0 0 / 0.1);
      border-radius: 8px;
      overflow: hidden;
      border: 10px solid transparent;
    }
    thead tr {
      background: #4a90e2;
      color: white;
      font-weight: 600;
    }
    thead th {
      padding: 12px 15px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 10;
      user-select: none;
    }
    tbody tr {
      transition: background-color 0.25s ease;
      cursor: pointer;
    }
    tbody tr:hover {
      background-color: #e8f0fe;
    }
    tbody td {
      padding: 12px 15px;
      vertical-align: middle;
      border-bottom: 1px solid #ddd;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    tbody td.editing {
      padding: 0;
    }
    tbody td input {
      width: 100%;
      padding: 10px 12px;
      border: none;
      outline: none;
      font-size: 0.95rem;
      font-family: inherit;
      border-radius: 0;
      box-sizing: border-box;
    }
    tbody td img.photo {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 50%;
      border: 1px solid #ccc;
    }
    button.deleteBtn {
      background: #ff4d4d;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    button.deleteBtn:hover {
      background: #e04343;
    }
    button {
      background: linear-gradient(135deg, #4a90e2, #357ABD);
      border: none;
      color: white;
      padding: 0.7rem 1.4rem;
      margin: 1rem 0 1rem 0;
      font-size: 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 600;
      box-shadow: 0 4px 10px rgb(74 144 226 / 0.4);
      transition: background 0.35s ease, box-shadow 0.35s ease, transform 0.15s ease;
      user-select: none;
    }
    button:hover {
      background: linear-gradient(135deg, #357ABD, #2B5D9D);
      box-shadow: 0 6px 18px rgb(53 122 189 / 0.6);
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 3px 6px rgb(53 122 189 / 0.3);
    }

    /* Updated icon to a modern plus with circle background */
    button svg {
      width: 18px;
      height: 18px;
      fill: white;
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }
    button:hover svg {
      transform: rotate(90deg);
    }
    /* Scroll horizontal on small screens */
    @media (max-width: 900px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      thead tr {
        display: table-row;
      }
      tbody tr {
        display: table-row;
      }
      tbody td, thead th {
        white-space: nowrap;
      }
    }
</style>
</head>
<body>

<h2>User Management</h2>
<button id="addUserBtn" title="Add New User" aria-label="Add New User">
  <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
    <circle cx="12" cy="12" r="10" fill="rgba(255,255,255,0.3)" />
    <path d="M12 7v10M7 12h10" stroke="white" stroke-width="2" stroke-linecap="round" />
  </svg>
  Add User
</button>

<table id="userTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Username</th>
      <th>adno</th>
      <th>Name</th>
      <th>Guardian</th>
      <th>Address</th>
      <th>Date of Birth</th>
      <th>Blood Group</th>
      <th>Phone</th>
      <th>Password</th>
      <th>Photo</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const userTableBody = document.querySelector('#userTable tbody');
  let users = [];
  let editingCell = null;

  async function fetchUsers() {
    const res = await fetch('/api/users');
    users = await res.json();
    renderTable();
  }

  function renderTable() {
    userTableBody.innerHTML = '';
    users.forEach((user, index) => {
      const tr = document.createElement('tr');

      ['id','Username','adno','Name','Guardian','address','dateofbirth','bloodgroup','phone','Password','Photo'].forEach(key => {
        const td = document.createElement('td');
        td.textContent = user[key] || '';
        td.dataset.key = key;
        td.dataset.index = index;
        td.classList.add('editable');
        tr.appendChild(td);
      });

      const actionTd = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => deleteUser(user.id);
      actionTd.appendChild(delBtn);
      tr.appendChild(actionTd);

      userTableBody.appendChild(tr);
    });
  }

  function startEditing(td) {
    if (editingCell) return; // only one cell at a time

    editingCell = td;
    const original = td.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = original;
    td.textContent = '';
    td.classList.add('editing');
    td.appendChild(input);
    input.focus();

    input.addEventListener('blur', () => saveEdit(input, original));
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') saveEdit(input, original);
      if (e.key === 'Escape') cancelEdit(original);
    });

    function saveEdit(input, original) {
      const val = input.value.trim();
      const key = td.dataset.key;
      const index = parseInt(td.dataset.index);
      if (key === 'Name' && val === '') {
        alert('Name is required!');
        input.focus();
        return;
      }
      td.textContent = val || original;
      td.classList.remove('editing');
      editingCell = null;

      // update user locally
      users[index][key] = val || original;

      // send update to server
      updateUser(users[index]);
    }

    function cancelEdit(original) {
      td.textContent = original;
      td.classList.remove('editing');
      editingCell = null;
    }
  }

  async function updateUser(user) {
    try {
      const res = await fetch('/api/users/' + user.id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(user)
      });
      if (!res.ok) {
        const error = await res.json();
        alert('Update failed: ' + error.error);
        fetchUsers();
      }
    } catch (e) {
      alert('Update failed');
      fetchUsers();
    }
  }

  async function deleteUser(id) {
    if (!confirm('Delete user?')) return;
    try {
      const res = await fetch('/api/users/' + id, { method: 'DELETE' });
      if (res.ok) {
        users = users.filter(u => u.id !== id);
        renderTable();
      } else {
        alert('Delete failed');
      }
    } catch (e) {
      alert('Delete failed');
    }
  }

  document.querySelector('#userTable tbody').addEventListener('click', e => {
    if (e.target.classList.contains('editable')) {
      startEditing(e.target);
    }
  });

  document.querySelector('#addUserBtn').addEventListener('click', async () => {
    const newUser = {
      Username: '',
      adno: '',
      Name: 'New User',
      Guardian: '',
      address: '',
      dateofbirth: '',
      bloodgroup: '',
      phone: '',
      Password: '',
      Photo: ''
    };

    try {
      const res = await fetch('/api/users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(newUser)
      });
      if (!res.ok) {
        const err = await res.json();
        alert('Add failed: ' + err.error);
        return;
      }
      const savedUser = await res.json();
      users.push(savedUser);
      renderTable();
    } catch (e) {
      alert('Add failed');
    }
  });

  fetchUsers();
</script>

</body>
</html>
